<!DOCTYPE html>
<html lang="zh">
<head>
    <meta name="viewport" content="width=device-width, initial-scale=1" charset="UTF-8"/>
    <title> AD FTP </title>
    <link rel="stylesheet" href="../css/style.css">
    <style>
        pre {
            font-family: monospace;
            margin: 0;
            padding: 0;
            white-space: pre;
            overflow-x: auto;
        }
        .file-list {
            background: rgba(255, 255, 255, 0.05);
            padding: 10px;
            border-radius: 5px;
            margin: 10px 0;
            min-width: 800px;
        }
        body {
            min-width: 850px;
            overflow-x: auto;
        }
        .container {
            min-width: 850px;
        }
    </style>
</head>
<body>
    <div class="main-bg"></div>
    
    <div class="container">
        <a href="../index.html" style="margin-bottom: 10px; display: inline-block;">← 返回首頁</a>
        
        <h1 id="current-path">AD</h1>

        <div class="file-list">
            <pre>
<a>    Name                                 Last modified          Size  </a>
<hr>
<div id="file-list-content"></div>
            </pre>
        </div>

        <hr>

        <address>Server at https://github.com/AD-devs/AD-dev</address>
        <address> © 2025 AD All rights reserved</address>
    </div>

    <script>
        const REPO_OWNER = 'AD-devs';
        const REPO_NAME = 'AD-dev';
        let currentPath = '';

        function shouldHideFile(file, path = '') {
            const name = file.name;
            const isDir = file.type === 'dir';
            
            if (path === '') {
                const rootHiddenFiles = ['.keep', 'Terminal', '.nojekyll', 'LICENSE.md', 
                                       '.github', '.gitignore', 'CNAME', 'index.html'];
                if (rootHiddenFiles.includes(name)) return true;
            }

            if (isDir) {
                const hiddenDirectories = ['.github', 'docs', 'assets', 'css', 'Other', 'Old'];
                if (hiddenDirectories.includes(name)) return true;
            }

            if (!isDir) {
                const hiddenExtensions = ['.html', '.yml', '.yaml'];
                if (hiddenExtensions.some(ext => name.endsWith(ext))) return true;
            }

            return name.startsWith('.') && name !== '.' && name !== '..';
        }
        async function getLastModifiedTime(filePath) {
            try {
                const apiUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/commits?path=${filePath}&per_page=1`;
                const response = await fetch(apiUrl);
                
                if (!response.ok) {
                    return null;
                }
                
                const commits = await response.json();
                
                if (commits.length > 0) {
                    return commits[0].commit.committer.date;
                }
                
                return null;
            } catch (error) {
                console.error('获取最后修改时间失败:', error);
                return null;
            }
        }

        async function loadDirectory(path = '') {
            try {
                currentPath = path;
                document.getElementById('current-path').textContent = path ? `AD/${path}` : 'AD';
                
                const targetPath = path ? `AD/${path}` : 'AD';
                const apiUrl = `https://api.github.com/repos/${REPO_OWNER}/${REPO_NAME}/contents/${targetPath}`;
                
                const response = await fetch(apiUrl);
                if (!response.ok) throw new Error(`HTTP error! status: ${response.status}`);
                
                const files = await response.json();
                const filteredFiles = files.filter(file => !shouldHideFile(file, path));

                const filesWithDates = await Promise.all(
                    filteredFiles.map(async (file) => {
                        const filePath = path ? `${path}/${file.name}` : file.name;
                        const lastModified = await getLastModifiedTime(`AD/${filePath}`);
                        return {
                            ...file,
                            lastModified: lastModified || file.updated_at || '-'
                        };
                    })
                );
                
                renderFileList(filesWithDates, path);
                
            } catch (error) {
                document.getElementById('file-list-content').innerHTML = `<span style="color: red;">加載失敗: ${error.message}</span>`;
            }
        }

        function renderFileList(files, path) {
            const fileList = document.getElementById('file-list-content');
            
            if (files.length === 0) {
                fileList.innerHTML = '<h1> 這裡空空如也 </h1>';
                return;
            }

            files.sort((a, b) => {
                if (a.type === b.type) return a.name.localeCompare(b.name);
                return a.type === 'dir' ? -1 : 1;
            });

            let html = '';
            
            if (path) {
                const parentPath = path.split('/').slice(0, -1).join('/');
                html += `<a href="javascript:void(0)" onclick="loadDirectory('${parentPath}')">../</a>`;

                html += '&nbsp;'.repeat(30 - 3) + `${formatDate('-')}&nbsp;&nbsp;&nbsp;&nbsp;-<br><br>`;
            }

            files.forEach(file => {
                const isDir = file.type === 'dir';
                const name = file.name + (isDir ? '/' : '');
                const nameLength = name.length;
                const spacesNeeded = 30 - nameLength;
                const modTime = formatDate(file.lastModified);
                const size = isDir ? '-' : formatFileSize(file.size);
                html += `<a `;

                if (isDir) {
                    const newPath = path ? `${path}/${file.name}` : file.name;
                    html += `<a href="javascript:void(0)" onclick="loadDirectory('${newPath}')">${name}</a>`;
                } else {
                    const downloadPath = path ? `AD/${path}/${file.name}` : `AD/${file.name}`;
                    const downloadUrl = `https://raw.githubusercontent.com/${REPO_OWNER}/${REPO_NAME}/main/${downloadPath}`;
                    html += `<a href="${downloadUrl}" target="_blank">${name}</a>`;
                }

                html += '&nbsp;'.repeat(Math.max(1, spacesNeeded)) + `${modTime}&nbsp;&nbsp;&nbsp;&nbsp;${size}<br><br>`;
            });
            
            fileList.innerHTML = html;
        }

        function formatDate(dateString) {
            if (!dateString || dateString === '-') return '-';
            try {
                const date = new Date(dateString);
                return date.toISOString().split('T')[0] + ' ' + 
                       date.toTimeString().split(' ')[0].substring(0, 5);
            } catch (e) {
                return '-';
            }
        }

        function formatFileSize(bytes) {
            if (!bytes) return '-';
            if (bytes < 1024) return bytes + 'B';
            if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + 'KB';
            return (bytes / (1024 * 1024)).toFixed(1) + 'MB';
        }

        addEventListener("load", function() {
            loadDirectory();
        });
    </script>
</body>
</html>